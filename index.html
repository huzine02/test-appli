<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutri-Track S√®che 10 Sem - Hocine</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-light: #a29bfe;
            --secondary: #FF7675;
            --accent: #FFEaa7;
            --bg-gradient: linear-gradient(180deg, #FFF5F0 0%, #FFF0E6 100%);
            --card-bg: #FFFFFF;
            --text-main: #2D3436;
            --text-light: #636E72;
            --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 25px 50px rgba(108, 92, 231, 0.15);
            --radius: 30px;
            --danger: #ff7675;
            --success: #55efc4;
            --nav-height: 80px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding: 0 0 var(--nav-height) 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 10px;
        }

        .header-text h1 {
            font-size: 20px;
            font-weight: 800;
            color: var(--text-main);
            text-transform: capitalize;
        }

        .header-text p {
            color: var(--text-light);
            font-size: 14px;
            margin-bottom: 2px;
        }

        /* --- ILLUSTRATIONS & AVATAR --- */
        .avatar-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-soft);
            border: 2px solid white;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .card-illustration {
            position: absolute;
            right: -10px;
            top: -10px;
            width: 80px;
            height: 80px;
            opacity: 0.9;
            transform: rotate(10deg);
            pointer-events: none;
            z-index: 0;
        }

        .card-content {
            position: relative;
            z-index: 1;
        }

        h2,
        h3 {
            color: var(--text-main);
            margin-bottom: 15px;
        }

        /* --- SEMAINIER (Weekly Calendar) --- */
        .semainier-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
            position: relative;
            z-index: 1;
        }

        .semainier-scroll::-webkit-scrollbar {
            display: none;
        }

        .jour-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            height: 70px;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .jour-badge.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
        }

        .jour-badge.today {
            border-color: var(--secondary);
            background: #fff0f0;
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(255, 118, 117, 0.2);
        }

        .jour-badge span {
            font-weight: 700;
            font-size: 14px;
        }

        .jour-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 8px;
            background-color: #dfe6e9;
        }

        .jour-badge.training .jour-dot {
            background-color: var(--secondary);
        }

        .jour-badge.repos .jour-dot {
            background-color: var(--success);
        }

        .jour-badge.active .jour-dot {
            background-color: white;
        }

        /* --- PROGRESSION --- */
        .progress-container {
            background: #f1f2f6;
            border-radius: 15px;
            height: 12px;
            width: 100%;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 15px;
            color: white;
            font-weight: 700;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .macro-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }

        .macro-item {
            background: #FAFAFA;
            padding: 10px;
            border-radius: 15px;
        }

        .macro-value {
            font-weight: 800;
            font-size: 16px;
            color: var(--primary);
        }

        .macro-label {
            font-size: 12px;
            color: var(--text-light);
        }

        /* --- MEALS --- */
        .nutrition-section {
            margin-bottom: 20px;
        }

        .meal {
            background: #FAFAFA;
            border-radius: 20px;
            padding: 15px;
            margin-top: 10px;
        }

        .meal-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .option-selector {
            margin: 10px 0;
        }

        .option-btn {
            padding: 8px 16px;
            border: 1px solid var(--primary-light);
            background: white;
            color: var(--primary);
            border-radius: 20px;
            margin-right: 5px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            transition: all 0.2s;
        }

        .option-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .validation-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 15px;
            cursor: pointer;
            border: 1px solid #eee;
        }

        .validation-checkbox.validated {
            background: #ecfdf5;
            border-color: var(--success);
            color: #00b894;
        }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: white;
            height: 70px;
            border-radius: 35px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            padding: 0 10px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 12px;
            cursor: pointer;
            width: 60px;
            transition: all 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-5px);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* --- CONTENT SECTIONS --- */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- HEADER -->
        <header>
            <div class="header-text">
                <p>Bonjour,</p>
                <h1 id="header-date">Chargement...</h1>
                <span id="season-badge"
                    style="background:var(--accent); padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold; display:inline-block; margin-top:5px;">üçÇ
                    AUTOMNE</span>
            </div>
            <div id="semainier-container" class="semainier-scroll">
                <!-- JS injected -->
            </div>
        </header>

        <!-- GLOBAL PROGRESSION (New) -->
        <div class="card">
            <div class="card-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3>Programme 10 Semaines</h3>
                    <span id="global-week-display" style="font-weight:bold; color:var(--primary);">S1/10</span>
                </div>
                <div class="progress-container" style="height:8px; margin:0;">
                    <div id="global-progress-bar" class="progress-bar" style="width:0%"></div>
                </div>
                <div id="timeline-items"
                    style="display:flex; overflow-x:auto; gap:10px; margin-top:15px; padding-bottom:5px; scrollbar-width:none;">
                    <!-- JS injected -->
                </div>
            </div>
        </div>

        <!-- POIDS (New) -->
        <div class="card">
            <div class="card-content">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Suivi Poids</h3>
                    <span id="poids-ecart" style="font-weight:bold; font-size:14px;">-0.0 kg</span>
                </div>
                <div style="display:flex; align-items:baseline; gap:5px; margin-top:5px;">
                    <span id="poids-actuel" style="font-size:24px; font-weight:800; color:var(--text-main);">85
                        kg</span>
                    <span style="font-size:12px; color:var(--text-light);">actuel (S<span
                            id="poids-semaine">1</span>)</span>
                </div>
                <p style="font-size:12px; color:var(--text-light); margin-top:5px;">Objectif: -0.5kg / semaine</p>

                <div
                    style="display:flex; align-items:center; gap:10px; margin-top:15px; padding-top:15px; border-top:1px solid #f1f2f6;">
                    <input type="number" id="poids-input" placeholder="Nouveau poids" step="0.1"
                        style="flex:1; padding:10px; border:1px solid #dfe6e9; border-radius:12px; font-family:'Nunito'; font-size:14px;">
                    <button onclick="updatePoids()"
                        style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:12px; cursor:pointer; font-weight:bold; font-family:'Nunito';">
                        OK
                    </button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <!-- Progression Card -->
            <div class="card">
                <div class="card-content">
                    <h3>Progression du Jour</h3>
                    <div id="day-display" style="font-weight:bold; color:var(--primary); margin-bottom:10px;">
                        Chargement...</div>

                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar">0%</div>
                    </div>

                    <div class="macro-grid">
                        <div class="macro-item">
                            <div class="macro-value"><span id="prot-actuel">0</span>/<span id="prot-total">0</span>
                            </div>
                            <div class="macro-label">Prot√©ines</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-value"><span id="gluc-actuel">0</span>/<span id="gluc-total">0</span>
                            </div>
                            <div class="macro-label">Glucides</div>
                        </div>
                        <div class="macro-item">
                            <div class="macro-value"><span id="lip-actuel">0</span>/<span id="lip-total">0</span></div>
                            <div class="macro-label">Lipides</div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:15px; font-size:14px;">
                        Total Calories: <strong onclick="editObjectifCalories()"
                            style="cursor:pointer; border-bottom:1px dashed var(--text-main);"
                            title="Modifier l'objectif"><span id="cal-actuel">0</span> / <span
                                id="cal-total">0</span></strong>
                    </div>
                </div>
            </div>

            <!-- Menu du Jour -->
            <div class="card">
                <img src="assets/meals.png" class="card-illustration" alt="Meals">
                <div class="card-content">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Menu du Jour</h3>
                        <span id="semaine-actuelle-label" style="font-size:12px; color:var(--text-light);">S1</span>
                    </div>
                    <div id="menu-container">
                        <!-- JS injected -->
                    </div>
                </div>
            </div>
        </div>

        <!-- TRAINING TAB -->
        <div id="tab-training" class="tab-content">
            <div class="card">
                <h3>Entra√Ænement</h3>
                <p>Programme √† venir...</p>
            </div>
        </div>

        <!-- PROFILE TAB -->
        <div id="tab-profile" class="tab-content">
            <div class="card">
                <h3>Configuration Semaine Type</h3>
                <p style="font-size:13px; color:var(--text-light); margin-bottom:15px;">Cochez vos jours d'entra√Ænement
                    habituels :</p>
                <div id="config-jours-container" style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px;">
                </div>

                <h4 style="margin-bottom:10px; color:var(--text-main);">Date de d√©but du programme</h4>
                <div style="display:flex; gap:10px;">
                    <input type="date" id="date-debut-input" onchange="updateDateDebut()"
                        style="padding:10px; border:1px solid #dfe6e9; border-radius:12px; font-family:'Nunito'; flex:1;">
                </div>
            </div>

            <div class="card">
                <h3>Pr√©f√©rences Alimentaires</h3>
                <p style="font-size:13px; color:var(--text-light); margin-bottom:15px;">Vos choix par d√©faut pour gagner
                    du temps :</p>

                <div style="margin-bottom:15px;">
                    <label style="font-size:14px; font-weight:600; display:block; margin-bottom:5px;">Collation Training
                        (15:45)</label>
                    <select id="pref-collation-training" onchange="savePreference('collation-training', this.value)"
                        style="width:100%; padding:10px; border-radius:10px; border:1px solid #dfe6e9;">
                        <option value="">-- Choisir --</option>
                        <option value="A">Option A - Clean (Whey + Avoine)</option>
                        <option value="B">Option B - Press√© (HiPro + Banane)</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="font-size:14px; font-weight:600; display:block; margin-bottom:5px;">D√Æner Training
                        (19:30)</label>
                    <select id="pref-diner-training" onchange="savePreference('diner-training', this.value)"
                        style="width:100%; padding:10px; border-radius:10px; border:1px solid #dfe6e9;">
                        <option value="">-- Choisir --</option>
                        <option value="A">Option A - Saumon</option>
                        <option value="B">Option B - Poulet</option>
                        <option value="C">Option C - ≈íufs</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="font-size:14px; font-weight:600; display:block; margin-bottom:5px;">Collation Repos
                        (16:00)</label>
                    <select id="pref-collation-repos" onchange="savePreference('collation-repos', this.value)"
                        style="width:100%; padding:10px; border-radius:10px; border:1px solid #dfe6e9;">
                        <option value="">-- Choisir --</option>
                        <option value="A">Option A - Plaisir (Pain + Beurre Cacahu√®te)</option>
                        <option value="B">Option B - Sant√© (Skyr + Amandes)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h3>Stack Suppl√©ments</h3>
                <div id="supplements-container"></div>
            </div>
        </div>

    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('dashboard')">
            <span class="nav-icon">üè†</span>
            <span>Accueil</span>
        </div>
        <div class="nav-item" onclick="switchTab('training')">
            <span class="nav-icon">üèãÔ∏è</span>
            <span>Sport</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <span class="nav-icon">üë§</span>
            <span>Profil</span>
        </div>
    </nav>

    <script>
        // --- DATA ---
        const SAISONS = {
            automne: { nom: 'Automne', mois: [9, 10, 11], emoji: 'üçÇ', fruits: ['Pomme', 'Raisin', 'Poire'], legumes: ['Courge', 'Carotte', 'Chou'] },
            hiver: { nom: 'Hiver', mois: [12, 1, 2], emoji: '‚ùÑÔ∏è', fruits: ['Orange', 'Kiwi'], legumes: ['Poireau', 'Endive'] },
            printemps: { nom: 'Printemps', mois: [3, 4, 5], emoji: 'üå∏', fruits: ['Fraise', 'Cerise'], legumes: ['Asperge', 'Radis'] },
            ete: { nom: '√ât√©', mois: [6, 7, 8], emoji: '‚òÄÔ∏è', fruits: ['Melon', 'P√™che'], legumes: ['Tomate', 'Poivron'] }
        };

        const PLAN_HYBRIDE = {
            dateDebut: localStorage.getItem('dateDebutProgramme') || '2024-01-01',
            semaines: {}
        };
        for (let i = 1; i <= 10; i++) {
            PLAN_HYBRIDE.semaines['S' + i] = {
                nom: i <= 4 ? 'Phase Adaptation' : 'Phase Intensive',
                calories: { training: 2800, repos: 2400 },
                macros: {
                    training: { P: 200, G: 300, L: 80 },
                    repos: { P: 200, G: 200, L: 90 }
                }
            };
        }

        const MENUS_BASE = {
            matin: {
                nom: 'üåÖ ROUTINE MATIN (√Ä JEUN)',
                heure: '07:30',
                details: [
                    'üíß 500ml Eau + Jus 1/2 citron',
                    '‚òï Caf√© Noir (Sans sucre)',
                    'üíä Cr√©atine : 5g (Indispensable)'
                ]
            },
            training: {
                repas: [
                    {
                        id: 'repas1_train',
                        nom: 'üïõ REPAS 1 - Rupture Je√ªne',
                        heure: '12:00',
                        calories: 900,
                        macros: { P: 60, G: 90, L: 30 },
                        desc: 'Le plus gros repas. Prot√©ines + Glucides + L√©gumes.',
                        complements: ['Vitamine D3 + K2', 'Multivitamine', 'Om√©ga-3 (sauf si poisson)', 'Berb√©rine'],
                        assiette: [
                            'üçó Prot√©ine (170g) : Poulet / Poisson Blanc / Steak 5%',
                            'üçö F√©culent (270g cuit) : Riz Basmati / P√¢tes / Patates',
                            'ü•¶ L√©gumes (300g) : Brocolis / Haricots / Courgettes',
                            'ü´í Lipides : 20ml Huile Olive (Crue)',
                            'üçé Fruit : 1 Pomme ou Poire'
                        ]
                    },
                    {
                        id: 'repas2_train',
                        nom: 'üïí REPAS 2 - Post-Training',
                        heure: '15:45',
                        calories: 600,
                        macros: { P: 40, G: 80, L: 10 },
                        desc: 'Juste apr√®s le sport. Anti-Cortisol.',
                        complements: ['Glycine (3-5g) optionnel'],
                        prefKey: 'collation-training',
                        options: [
                            { id: 'A', nom: 'Option A - Clean', aliments: ['ü•§ Whey Isolate (40g)', 'üçå 1.5 Banane', 'ü•£ Avoine Poudre (40g)', 'üçì Fruits Rouges (100g)'] },
                            { id: 'B', nom: 'Option B - Press√©', aliments: ['ü•§ Danone HiPro Vanille', 'üçå 2 Bananes', 'ü•ú 20g Amandes'] }
                        ]
                    },
                    {
                        id: 'repas3_train',
                        nom: 'üï¢ REPAS 3 - D√Æner',
                        heure: '19:30',
                        calories: 800,
                        macros: { P: 50, G: 60, L: 35 },
                        desc: 'Digestion & Sommeil.',
                        complements: ['Magn√©sium (400mg)', 'Zinc (15mg)', 'Om√©ga-3'],
                        prefKey: 'diner-training',
                        options: [
                            { id: 'A', nom: 'Option A - Saumon', aliments: ['üêü Saumon (150g)', 'üç† Patate Douce (180g)', 'ü•ó L√©gumes √† volont√©', '‚ùå Pas d\'huile ajout√©e'] },
                            { id: 'B', nom: 'Option B - Poulet', aliments: ['üçó Cuisse Poulet (200g)', 'üçö Riz Basmati (180g)', 'ü•ó L√©gumes √† volont√©', '‚ùå Pas d\'huile ajout√©e'] },
                            { id: 'C', nom: 'Option C - ≈íufs', aliments: ['ü•ö 3 ≈íufs + 1 Blanc', 'üåæ Quinoa (180g)', 'ü•ó L√©gumes', 'ü´í 10ml Huile'] }
                        ],
                        dessert: 'Skyr 0% (200g) + Miel (15g) + Framboises'
                    }
                ]
            },
            repos: {
                repas: [
                    {
                        id: 'repas1_repos',
                        nom: 'üïõ REPAS 1',
                        heure: '12:00',
                        calories: 700,
                        macros: { P: 50, G: 50, L: 30 },
                        complements: ['Vitamine D3 + K2', 'Multivitamine', 'Om√©ga-3'],
                        assiette: [
                            'üçó Prot√©ine (170g) : Volaille / Steak / Poisson',
                            'üçö F√©culent (200g cuit) : Portion r√©duite',
                            'ü•¶ L√©gumes (300g min)',
                            'ü´í Lipides : 20ml Huile Olive',
                            'üçé Fruit : 1 Pomme'
                        ]
                    },
                    {
                        id: 'repas2_repos',
                        nom: 'üïì COLLATION',
                        heure: '16:00',
                        calories: 400,
                        macros: { P: 30, G: 40, L: 15 },
                        prefKey: 'collation-repos',
                        options: [
                            { id: 'A', nom: 'Option A - Plaisir (2x max)', aliments: ['üçû 2 Pains Complets + 25g Beurre Cacahu√®te', 'üçå 1/2 Banane', 'ü•§ Petit shake si faim'] },
                            { id: 'B', nom: 'Option B - Sant√©', aliments: ['üç∂ Skyr (200g)', 'ü•ú 25g Amandes/Noix', 'ü•ù 1 Fruit (Kiwi/Pomme)'] }
                        ]
                    },
                    {
                        id: 'repas3_repos',
                        nom: 'üï¢ REPAS 3',
                        heure: '19:30',
                        calories: 600,
                        macros: { P: 45, G: 30, L: 30 },
                        complements: ['Magn√©sium', 'Zinc'],
                        options: [
                            { id: 'A', nom: 'Option A - Standard', aliments: ['üêü Prot√©ine (150g) : Saumon/Sardines/≈íufs', 'üçö F√©culent (120g) : Portion l√©g√®re', 'ü•ó L√©gumes √† volont√©'] },
                            { id: 'B', nom: 'Option B - L√©ger', aliments: ['ü•ó Grande Salade Compos√©e', 'üêü Thon/Maquereau', 'ü•ë 1/2 Avocat'] }
                        ],
                        dessert: 'Skyr nature + Cannelle (Pas de miel)'
                    }
                ]
            },
            vendredi: {
                repas3: {
                    id: 'repas3_vendredi',
                    nom: 'üóìÔ∏è VENDREDI SOIR (80/20 Safe)',
                    heure: '20:00',
                    calories: 1200,
                    macros: { P: 40, G: 100, L: 50 },
                    desc: 'Repas plaisir contr√¥l√©.',
                    aliments: [
                        'ü•ó Entr√©e : Salade verte + Vinaigre (Obligatoire)',
                        'üçü Plat : Steak/Poulet + 300g Frites Maison (Air Fryer)',
                        'üç´ Dessert : Chocolat Noir ou Fruit'
                    ]
                }
            }
        };

        const STACK_SUPPLEMENTS_COMPLET = {
            basique: {
                articulations: { glucosamine: { dose: '1500mg', prix: '15‚Ç¨/mois' }, msm: { dose: '2000mg', prix: '10‚Ç¨/mois' }, boswellia: { dose: '1000mg', prix: '15‚Ç¨/mois' } },
                performance: { creatine: { dose: '5g/j', prix: '8‚Ç¨/mois' }, whey: { dose: '60-90g/j', prix: '40‚Ç¨/mois' }, omega3: { dose: '2-4g/j', prix: '20‚Ç¨/mois' } },
                sante: { vitamine_d3: { dose: '5000 UI', prix: '8‚Ç¨/mois' }, magnesium: { dose: '400mg', prix: '10‚Ç¨/mois' }, zinc: { dose: '30mg', prix: '8‚Ç¨/mois' } }
            },
            diabete: {
                berberine: { dose: '500mg 3√ó/jour', prix: '15‚Ç¨/mois', note: 'PRIORIT√â #1' },
                chrome: { dose: '200mcg 2√ó/jour', prix: '5‚Ç¨/mois' }
            }
        };

        const AJUSTEMENTS_MACROS = {
            optionA: { nom: 'Option A - √âquilibr√©', desc: 'Ajustements l√©gers', details: 'Poulet +20g, Riz -8g glucides' },
            optionB: { nom: 'Option B - Strict', desc: 'Si plateau > 2 semaines', details: 'Suppression banane, Riz -17g' }
        };

        // --- STATE ---
        function getSaison() { const mois = new Date().getMonth() + 1; for (const [key, saison] of Object.entries(SAISONS)) { if (saison.mois.includes(mois)) return saison } return SAISONS.automne }
        let SAISON_ACTUELLE = getSaison();
        let semaineActuelle = 'S1';
        let jourType = 'training';
        let grignotages = JSON.parse(localStorage.getItem('grignotages') || '[]');
        let pesees = JSON.parse(localStorage.getItem('pesees-hebdo') || '[]');
        let optionsSelectionnees = JSON.parse(localStorage.getItem('options-repas') || '{}');
        let planningHebdo = JSON.parse(localStorage.getItem('planningHebdo') || '[1, 2, 4, 5]');
        let preferencesMenu = JSON.parse(localStorage.getItem('preferences-menu') || '{}');

        // --- INIT ---
        window.onload = function () {
            updateDateDisplay();
            updateSeasonDisplay();
            // Init date input
            const dateInput = document.getElementById('date-debut-input');
            if (dateInput) dateInput.value = PLAN_HYBRIDE.dateDebut;

            // Init preferences selectors
            for (const [key, val] of Object.entries(preferencesMenu)) {
                const el = document.getElementById('pref-' + key);
                if (el) el.value = val;
            }

            semaineActuelle = getSemaineActuelle();
            afficherSemainier();
            checkDayAuto();
            afficherMenu();
            calculerProgression();
            createTimelineItems();
            afficherStackSupplements();
            renderConfigJours();
            calculerProgressionProgramme();
            calculerSuiviPoids();
        };

        // --- LOGIC ---
        const JOURS_SEMAINE = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const MOIS_ANNEE = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

        function updateDateDisplay() {
            const today = new Date();
            const jour = JOURS_SEMAINE[today.getDay()];
            const num = today.getDate();
            const mois = MOIS_ANNEE[today.getMonth()];
            document.getElementById('header-date').textContent = `${jour} ${num} ${mois}`;
        }

        function updateDateDebut() {
            const input = document.getElementById('date-debut-input');
            if (input && input.value) {
                PLAN_HYBRIDE.dateDebut = input.value;
                localStorage.setItem('dateDebutProgramme', input.value);
                semaineActuelle = getSemaineActuelle();
                afficherMenu();
                calculerProgression();
                calculerProgressionProgramme();
                createTimelineItems(); // Update active dot
                alert("Date de d√©but mise √† jour ! Semaine actuelle : " + semaineActuelle);
            }
        }

        function renderConfigJours() {
            const container = document.getElementById('config-jours-container');
            if (!container) return;
            let html = '';
            const ordre = [1, 2, 3, 4, 5, 6, 0];

            ordre.forEach(idx => {
                const isChecked = planningHebdo.includes(idx);
                html += `<label style="display:flex; align-items:center; gap:8px; background:#f1f2f6; padding:8px 12px; border-radius:10px; cursor:pointer;">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleConfigJour(${idx})">
                    <span style="font-size:14px; font-weight:600; color:var(--text-main);">${JOURS_SEMAINE[idx]}</span>
                </label>`;
            });
            container.innerHTML = html;
        }

        function toggleConfigJour(dayIndex) {
            const idx = planningHebdo.indexOf(dayIndex);
            if (idx > -1) planningHebdo.splice(idx, 1);
            else planningHebdo.push(dayIndex);

            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherSemainier();
            renderConfigJours();

            if (dayIndex === new Date().getDay()) {
                checkDayAuto();
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const icons = { 'dashboard': 0, 'training': 1, 'profile': 2 };
            document.querySelectorAll('.nav-item')[icons[tabName]].classList.add('active');
        }

        function afficherSemainier() {
            const todayIndex = new Date().getDay();
            let html = '';
            const ordreJours = [1, 2, 3, 4, 5, 6, 0];

            ordreJours.forEach(idx => {
                const isTraining = planningHebdo.includes(idx);
                const isToday = idx === todayIndex;
                html += `<div class="jour-badge ${isTraining ? 'training' : 'repos'} ${isToday ? 'today' : ''}"
                    onclick="toggleJourPlanning(${idx})">
                    <span>${JOURS_SEMAINE[idx]}</span>
                    <div class="jour-dot"></div>
                </div>`;
            });
            document.getElementById('semainier-container').innerHTML = html;
        }

        function toggleJourPlanning(dayIndex) {
            const idx = planningHebdo.indexOf(dayIndex);
            if (idx > -1) planningHebdo.splice(idx, 1);
            else planningHebdo.push(dayIndex);

            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherSemainier();

            if (dayIndex === new Date().getDay()) {
                checkDayAuto();
            }
        }

        function checkDayAuto() {
            const todayIndex = new Date().getDay();
            const isTrainingToday = planningHebdo.includes(todayIndex);
            const newType = isTrainingToday ? 'training' : 'repos';

            if (jourType !== newType) {
                setDayType(newType);
            } else {
                loadDayType();
            }
        }

        function getSemaineActuelle() {
            const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
            const aujourdhui = new Date();
            const diffJours = Math.floor((aujourdhui - dateDebut) / (1000 * 60 * 60 * 24));
            const numSemaine = Math.floor(diffJours / 7) + 1;
            return 'S' + (numSemaine > 10 ? 10 : numSemaine < 1 ? 1 : numSemaine);
        }

        function updateSeasonDisplay() {
            SAISON_ACTUELLE = getSaison();
            document.getElementById('season-badge').textContent = SAISON_ACTUELLE.emoji + ' ' + SAISON_ACTUELLE.nom.toUpperCase();
        }

        function setDayType(type) {
            jourType = type;
            localStorage.setItem('jourType', type);
            document.getElementById('day-display').textContent = type === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS';
            afficherMenu();
            calculerProgression();
        }

        function loadDayType() {
            const saved = localStorage.getItem('jourType');
            if (saved) jourType = saved;
            document.getElementById('day-display').textContent = jourType === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS';
        }

        function savePreference(key, value) {
            preferencesMenu[key] = value;
            localStorage.setItem('preferences-menu', JSON.stringify(preferencesMenu));
            afficherMenu(); // Refresh menu to apply new default
            calculerProgression();
        }

        function afficherMenu() {
            const menu = MENUS_BASE[jourType];
            const config = PLAN_HYBRIDE.semaines[semaineActuelle] || PLAN_HYBRIDE.semaines['S1'];
            document.getElementById('semaine-actuelle-label').textContent = `${semaineActuelle} - ${config.nom.toUpperCase()}`;

            let html = '';

            // 1. ROUTINE MATIN
            const matin = MENUS_BASE.matin;
            html += `<div class="nutrition-section" style="background:#fff5f0; padding:15px; border-radius:20px; border:1px solid #ffeaa7; margin-bottom:20px;">
                <h3 style="color:#d35400; margin-bottom:10px;">${matin.nom}</h3>
                <ul style="list-style:none;">
                    ${matin.details.map(d => `<li style="margin-bottom:5px; font-size:13px;">${d}</li>`).join('')}
                </ul>
            </div>`;

            // 2. REPAS
            menu.repas.forEach(repas => {
                // LOGIQUE VENDREDI SOIR
                const dayIndex = new Date().getDay();
                let currentRepas = repas;
                let isVendrediSoir = (dayIndex === 5 && repas.id.includes('repas3')); // 5 = Vendredi

                if (isVendrediSoir) {
                    currentRepas = MENUS_BASE.vendredi.repas3;
                }

                const valide = isRepasValide(currentRepas.id);

                html += `<div class="nutrition-section">
                    <div style="display:flex; justify-content:space-between; align-items:baseline;">
                        <h3>${currentRepas.heure} - ${currentRepas.nom}</h3>
                        ${isVendrediSoir ? '<span style="font-size:10px; background:#ffeaa7; padding:2px 6px; border-radius:10px;">üéâ 80/20</span>' : ''}
                    </div>
                    <div class="meal">
                        <div class="meal-details">
                            <div class="detail-item"><span class="detail-label">Cal:</span> ${currentRepas.calories}</div>
                            <div class="detail-item"><span class="detail-label">P:</span> ${currentRepas.macros.P}g</div>
                            <div class="detail-item"><span class="detail-label">G:</span> ${currentRepas.macros.G}g</div>
                            <div class="detail-item"><span class="detail-label">L:</span> ${currentRepas.macros.L}g</div>
                        </div>
                        ${currentRepas.desc ? `<p style="font-size:12px; color:var(--text-light); margin-bottom:10px; font-style:italic;">${currentRepas.desc}</p>` : ''}
                        `;

                // COMPLEMENTS
                if (currentRepas.complements) {
                    html += `<div style="margin-bottom:10px; font-size:12px; background:#eef2f3; padding:8px; border-radius:10px;">
                        <strong>üíä Compl√©ments:</strong> ${currentRepas.complements.join(', ')}
                    </div>`;
                }

                // CONTENU (ASSIETTE ou OPTIONS)
                if (currentRepas.options) {
                    const today = new Date().toISOString().split('T')[0];
                    const optionKey = `${today}-${currentRepas.id}`;

                    // Smart Default : Preference or First Option
                    let defaultOption = currentRepas.options[0].id;
                    if (currentRepas.prefKey && preferencesMenu[currentRepas.prefKey]) {
                        defaultOption = preferencesMenu[currentRepas.prefKey];
                    }

                    const optionSelectionnee = optionsSelectionnees[optionKey] || defaultOption;

                    // Save default if not set
                    if (!optionsSelectionnees[optionKey]) {
                        optionsSelectionnees[optionKey] = defaultOption;
                    }

                    html += `<div class="option-selector"><strong>üîÑ Choix option :</strong><br>`;
                    currentRepas.options.forEach(opt => {
                        const isActive = opt.id === optionSelectionnee;
                        html += `<button class="option-btn ${isActive ? 'active' : ''}" onclick="selectOption('${currentRepas.id}', '${opt.id}')">${opt.nom}</button>`;
                    });
                    html += `</div>`;

                    const optionChoisie = currentRepas.options.find(o => o.id === optionSelectionnee);
                    if (optionChoisie) {
                        html += `<div class="meal-foods">
                            <ul style="padding-left:20px;">${optionChoisie.aliments.map(a => `<li>${a}</li>`).join('')}</ul>
                        </div>`;
                    }
                } else if (currentRepas.assiette) {
                    html += `<div class="meal-foods"><strong>üçΩÔ∏è L'Assiette (1 choix/ligne) :</strong>
                        <ul style="padding-left:20px;">${currentRepas.assiette.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>`;
                } else if (currentRepas.aliments) {
                    html += `<div class="meal-foods">
                        <ul style="padding-left:20px;">${currentRepas.aliments.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>`;
                }

                if (currentRepas.dessert) {
                    html += `<div style="margin-top:10px; font-size:13px; color:var(--primary);"><strong>üç® Dessert :</strong> ${currentRepas.dessert}</div>`;
                }

                html += `<div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${currentRepas.id}')">
                        <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
                        <span><strong>${valide ? '‚úÖ Valid√©' : '‚è∏Ô∏è √Ä valider'}</strong></span>
                    </div>
                </div>
            </div>`;
            });
            document.getElementById('menu-container').innerHTML = html;
        }

        function selectOption(repasId, optionId) {
            const today = new Date().toISOString().split('T')[0];
            optionsSelectionnees[`${today}-${repasId}`] = optionId;
            localStorage.setItem('options-repas', JSON.stringify(optionsSelectionnees));
            afficherMenu();
            calculerProgression();
        }

        function toggleRepas(repasId) {
            const today = new Date().toISOString().split('T')[0];
            const key = `repas-${today}`;
            let validations = JSON.parse(localStorage.getItem(key) || '[]');
            const index = validations.indexOf(repasId);
            if (index > -1) validations.splice(index, 1);
            else validations.push(repasId);
            localStorage.setItem(key, JSON.stringify(validations));
            afficherMenu();
            calculerProgression();
        }

        function isRepasValide(repasId) {
            const today = new Date().toISOString().split('T')[0];
            return (JSON.parse(localStorage.getItem(`repas-${today}`) || '[]')).includes(repasId);
        }

        function calculerProgression() {
            const menu = MENUS_BASE[jourType];
            const config = PLAN_HYBRIDE.semaines[semaineActuelle] || PLAN_HYBRIDE.semaines['S1'];
            const today = new Date().toISOString().split('T')[0];
            const validations = JSON.parse(localStorage.getItem(`repas-${today}`) || '[]');

            let total = { cal: 0, p: 0, g: 0, l: 0 };

            validations.forEach(id => {
                // Check normal meals
                let repas = menu.repas.find(r => r.id === id);

                // Check Vendredi special
                if (!repas && id === 'repas3_vendredi') {
                    repas = MENUS_BASE.vendredi.repas3;
                }

                if (repas) {
                    total.cal += repas.calories;
                    total.p += repas.macros.P;
                    total.g += repas.macros.G;
                    total.l += repas.macros.L;
                }
            });

            const grigJour = grignotages.filter(g => g.date === today);
            total.cal += grigJour.reduce((sum, g) => sum + g.calories, 0);

            // Gestion objectif personnalis√©
            const customGoal = localStorage.getItem('objectif-calories-' + jourType);
            const objectifCal = customGoal ? parseInt(customGoal) : config.calories[jourType];

            document.getElementById('cal-actuel').textContent = total.cal;
            document.getElementById('cal-total').textContent = objectifCal;
            document.getElementById('prot-actuel').textContent = total.p;
            document.getElementById('prot-total').textContent = config.macros[jourType].P;
            document.getElementById('gluc-actuel').textContent = total.g;
            document.getElementById('gluc-total').textContent = config.macros[jourType].G;
            document.getElementById('lip-actuel').textContent = total.l;
            document.getElementById('lip-total').textContent = config.macros[jourType].L;

            const pct = Math.min(100, Math.round((total.cal / objectifCal) * 100));
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-bar').textContent = pct + '%';
        }

        function editObjectifCalories() {
            const currentGoal = document.getElementById('cal-total').textContent;
            const newGoal = prompt("Entrez votre nouvel objectif calorique pour les jours " + jourType.toUpperCase() + " :", currentGoal);

            if (newGoal && !isNaN(newGoal)) {
                localStorage.setItem('objectif-calories-' + jourType, newGoal);
                calculerProgression();
            }
        }

        function calculerProgressionProgramme() {
            const num = parseInt(semaineActuelle.replace('S', ''));
            const pct = Math.min(100, Math.round((num / 10) * 100));

            const bar = document.getElementById('global-progress-bar');
            const label = document.getElementById('global-week-display');

            if (bar) bar.style.width = pct + '%';
            if (label) label.textContent = `${semaineActuelle}/10`;
        }

        function calculerSuiviPoids() {
            const dernierPoids = pesees.length > 0 ? pesees[pesees.length - 1].poids : 85;
            const poidsDepart = 85;
            const objectifHebdo = 0.5;
            const numSemaine = parseInt(semaineActuelle.replace('S', ''));

            const objectifTheorique = poidsDepart - (objectifHebdo * (numSemaine - 1));
            const ecart = (dernierPoids - objectifTheorique).toFixed(1);

            document.getElementById('poids-actuel').textContent = dernierPoids + ' kg';
            document.getElementById('poids-semaine').textContent = numSemaine;

            const ecartEl = document.getElementById('poids-ecart');
            if (ecartEl) {
                ecartEl.textContent = (ecart > 0 ? '+' : '') + ecart + ' kg';
                ecartEl.style.color = ecart <= 0 ? '#00b894' : '#ff7675';
            }
        }

        function updatePoids() {
            const input = document.getElementById('poids-input');
            const nouveauPoids = parseFloat(input.value);

            if (!nouveauPoids || isNaN(nouveauPoids)) {
                alert("Veuillez entrer un poids valide.");
                return;
            }

            const today = new Date().toISOString().split('T')[0];

            // V√©rifier si une pes√©e existe d√©j√† pour aujourd'hui
            const existingIndex = pesees.findIndex(p => p.date === today);
            if (existingIndex > -1) {
                pesees[existingIndex].poids = nouveauPoids;
            } else {
                pesees.push({ date: today, poids: nouveauPoids });
            }

            localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
            input.value = '';
            calculerSuiviPoids();
            alert("Poids mis √† jour !");
        }

        function createTimelineItems() {
            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `<div class="timeline-item" onclick="afficherSemaine(${i})"
                style="flex:0 0 auto; text-align:center; cursor:pointer; padding:5px;">
                <div class="timeline-dot"
                    style="width:30px; height:30px; background:var(--primary-light); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto;">
                    S${i}</div>
                <div class="timeline-label" style="font-size:10px; margin-top:4px;">Sem ${i}</div>
                </div>`;
            }
            document.getElementById('timeline-items').innerHTML = html;
        }

        function afficherSemaine(num) {
            semaineActuelle = 'S' + num;
            afficherMenu();
            calculerProgression();
            calculerProgressionProgramme(); // Update global progress bar
            document.querySelectorAll('.timeline-dot').forEach((el, idx) => {
                el.style.background = (idx + 1) === num ? 'var(--primary)' : 'var(--primary-light)';
            });
        }

        function afficherStackSupplements() {
            let html = '';
            for (const [cat, items] of Object.entries(STACK_SUPPLEMENTS_COMPLET.basique)) {
                html += `<div style="margin-bottom:15px;">
                    <h4 style="color:var(--secondary); margin-bottom:5px;">${cat.toUpperCase()}</h4>
                    <ul style="list-style:none;">`;
                for (const [name, det] of Object.entries(items)) {
                    html += `<li style="font-size:13px; margin-bottom:4px;"><strong>${name}:</strong> ${det.dose}
                                <span style="color:#888;">(${det.prix})</span>
                            </li>`;
                }
                html += `</ul>
                </div>`;
            }
            document.getElementById('supplements-container').innerHTML = html;
        }
    </script>
</body>

</html>
