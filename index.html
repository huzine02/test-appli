<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nutri-Track Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-light: #a29bfe;
            --secondary: #FF7675;
            --accent: #FFEaa7;
            --bg-gradient: linear-gradient(180deg, #FFF5F0 0%, #FFF0E6 100%);
            --card-bg: #FFFFFF;
            --text-main: #2D3436;
            --text-light: #636E72;
            --shadow-soft: 0 10px 20px rgba(0, 0, 0, 0.05);
            --radius: 20px;
            --nav-height: 70px;
            --success: #55efc4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: calc(var(--nav-height) + 20px);
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 5px;
        }

        .header-text h1 {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-main);
        }

        .header-text p {
            font-size: 14px;
            color: var(--text-light);
        }

        .season-badge {
            background: rgba(255, 255, 255, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(5px);
        }

        /* TIMELINE */
        .timeline-wrapper {
            overflow-x: auto;
            padding: 10px 0;
            margin: 0 -15px 20px -15px;
            padding-left: 15px;
            scrollbar-width: none;
        }

        .timeline-wrapper::-webkit-scrollbar {
            display: none;
        }

        .timeline-container {
            display: flex;
            gap: 15px;
            width: max-content;
            padding-right: 15px;
        }

        /* TABS */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CARDS */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        /* NUTRITION SECTION */
        .nutrition-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }

        .nutrition-section h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
        }

        .menu-icon {
            width: 35px;
            height: 35px;
            object-fit: contain;
            margin-right: 10px;
            vertical-align: middle;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .meal-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
        }

        .detail-label {
            font-size: 10px;
            color: var(--text-light);
            font-weight: 400;
            margin-bottom: 2px;
        }

        /* SEMAINIER */
        .semainier {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            /* Reduced padding for mobile */
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
        }

        .jour-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 13%;
            /* Responsive width */
            max-width: 40px;
        }

        .jour-badge span {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .jour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dfe6e9;
            transition: 0.3s;
        }

        .jour-badge.training .jour-dot {
            background: var(--primary);
        }

        .jour-badge.repos .jour-dot {
            background: var(--secondary);
        }

        .jour-badge.today span {
            color: var(--primary);
            font-weight: 800;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
            z-index: 100;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #b2bec3;
            font-size: 12px;
            font-weight: 600;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-5px);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* BUTTONS & INPUTS */
        button {
            border: none;
            outline: none;
            cursor: pointer;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: #f1f2f6;
            border-radius: 12px;
            text-align: left;
            font-size: 14px;
            color: var(--text-light);
            transition: 0.2s;
        }

        .option-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .validation-checkbox {
            margin-top: 15px;
            padding: 12px;
            background: #f1f2f6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .validation-checkbox.validated {
            background: var(--success);
            color: white;
        }

        /* PROGRESS BARS */
        .progress-container {
            background: #dfe6e9;
            border-radius: 10px;
            height: 10px;
            width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }

        .stat-value {
            object-fit: contain;
            margin-right: 10px;
            vertical-align: middle;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .meal-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            font-weight: 700;
        }

        .detail-label {
            font-size: 10px;
            color: var(--text-light);
            font-weight: 400;
            margin-bottom: 2px;
        }

        /* SEMAINIER */
        .semainier {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            /* Reduced padding for mobile */
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
        }

        .jour-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 13%;
            /* Responsive width */
            max-width: 40px;
        }

        .jour-badge span {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .jour-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dfe6e9;
            transition: 0.3s;
        }

        .jour-badge.training .jour-dot {
            background: var(--primary);
        }

        .jour-badge.repos .jour-dot {
            background: var(--secondary);
        }

        .jour-badge.today span {
            color: var(--primary);
            font-weight: 800;
        }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
            z-index: 100;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #b2bec3;
            font-size: 12px;
            font-weight: 600;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-5px);
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* BUTTONS & INPUTS */
        button {
            border: none;
            outline: none;
            cursor: pointer;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            background: #f1f2f6;
            border-radius: 12px;
            text-align: left;
            font-size: 14px;
            color: var(--text-light);
            transition: 0.2s;
        }

        .option-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
        }

        .validation-checkbox {
            margin-top: 15px;
            padding: 12px;
            background: #f1f2f6;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.3s;
        }

        .validation-checkbox.validated {
            background: var(--success);
            color: white;
        }

        /* PROGRESS BARS */
        .progress-container {
            background: #dfe6e9;
            border-radius: 10px;
            height: 10px;
            width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        /* CHART */
        .chart-svg {
            width: 100%;
            height: 200px;
        }

        /* GRIGNOTAGE */
        .snack-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #fff5f0;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <div class="header-text">
                <h1>Nutri-Track</h1>
                <p id="date-display">Chargement...</p>
            </div>
            <div id="season-badge" class="season-badge">‚ùÑÔ∏è HIVER</div>
        </header>

        <!-- Timeline -->
        <div class="timeline-wrapper">
            <div id="timeline-items" class="timeline-container">
                <!-- JS Injected -->
            </div>
        </div>

        <main>
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="tab-content">
                <div class="card">
                    <h3>üìä Progression & Poids</h3>
                    <div class="chart-container" id="chart-poids" style="height: 200px; margin: 15px 0;">
                        <svg class="chart-svg" id="svg-poids"></svg>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="poids-actuel">-- kg</div>
                            <div class="stat-label">Actuel</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="poids-objectif">-- kg</div>
                            <div class="stat-label">Objectif Semaine</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚öñÔ∏è Saisie Pes√©e Compl√®te</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <input type="number" id="input-poids" placeholder="Poids (kg)" step="0.1" class="option-btn"
                            style="background: white; border: 1px solid #dfe6e9; margin:0;">
                        <input type="number" id="input-bf" placeholder="% Graisse" step="0.1" class="option-btn"
                            style="background: white; border: 1px solid #dfe6e9; margin:0;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <input type="number" id="input-taille" placeholder="Taille (cm)" step="0.5" class="option-btn"
                            style="background: white; border: 1px solid #dfe6e9; margin:0;">
                        <input type="number" id="input-energie" placeholder="√ânergie (1-10)" min="1" max="10"
                            class="option-btn" style="background: white; border: 1px solid #dfe6e9; margin:0;">
                    </div>
                    <textarea id="input-notes-pesee" placeholder="Notes (sensations, digestion...)"
                        style="width: 100%; padding: 10px; border-radius: 12px; border: 1px solid #dfe6e9; margin-top: 10px; font-family: inherit; resize: none;"></textarea>
                    <button onclick="enregistrerPesee()"
                        style="width: 100%; background: var(--primary); color: white; padding: 12px; border-radius: 12px; font-weight: 700; margin-top: 10px;">Enregistrer
                        Pes√©e</button>
                </div>

                <div id="historique-pesees"></div>
            </div>

            <!-- TRAINING TAB (Active by default) -->
            <div id="tab-training" class="tab-content active">
                <div id="semainier-container" class="semainier">
                    <!-- JS Injected -->
                </div>

                <div id="day-display" class="card"
                    style="text-align: center; font-weight: 800; color: var(--primary); padding: 15px;">
                    üèãÔ∏è JOUR TRAINING
                </div>

                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3>üî• Calories du jour</h3>
                        <button onclick="editObjectifCalories()"
                            style="font-size: 12px; color: var(--primary); background: none; text-decoration: underline;">Modifier</button>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;">
                        <span><span id="cal-actuel">0</span> / <span id="cal-total">2800</span> kcal</span>
                        <span id="progress-bar">0%</span>
                    </div>
                    <div class="progress-container">
                        <div id="progress-bar-visual" class="progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="meal-details" style="margin-top: 15px; background: none; padding: 0;">
                        <div class="detail-item"><span class="stat-value" style="font-size: 16px;"
                                id="prot-actuel">0</span><span class="detail-label">Prot (/<span
                                    id="prot-total">0</span>)</span></div>
                        <div class="detail-item"><span class="stat-value" style="font-size: 16px;"
                                id="gluc-actuel">0</span><span class="detail-label">Gluc (/<span
                                    id="gluc-total">0</span>)</span></div>
                        <div class="detail-item"><span class="stat-value" style="font-size: 16px;"
                                id="lip-actuel">0</span><span class="detail-label">Lip (/<span
                                    id="lip-total">0</span>)</span></div>
                    </div>
                </div>

                <div class="card">
                    <h3>üç™ Grignotages & √âcarts</h3>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <input type="text" id="input-snack-nom" placeholder="Quoi ?"
                            style="flex: 2; padding: 10px; border-radius: 10px; border: 1px solid #dfe6e9;">
                        <input type="number" id="input-snack-cal" placeholder="Kcal"
                            style="flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #dfe6e9;">
                    </div>
                    <button onclick="ajouterGrignotage()"
                        style="width: 100%; background: var(--secondary); color: white; padding: 10px; border-radius: 10px; font-weight: 700; margin-top: 10px;">+
                        Ajouter</button>
                    <div id="liste-grignotages" style="margin-top: 15px;"></div>
                </div>

                <div id="menu-container">
                    <!-- JS Injected -->
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="tab-profile" class="tab-content">
                <div class="card">
                    <h3>‚öôÔ∏è Configuration</h3>
                    <div style="margin-top: 15px;">
                        <label
                            style="font-size: 14px; color: var(--text-light); display: block; margin-bottom: 8px;">Date
                            de d√©but</label>
                        <input type="date" id="date-debut-input" onchange="updateDateDebut()"
                            style="width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #dfe6e9; font-size: 16px;">
                    </div>
                </div>

                <div class="card">
                    <h3>üìÖ Jours d'entra√Ænement</h3>
                    <div id="config-jours-container"
                        style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                        <!-- JS Injected -->
                    </div>
                </div>

                <div class="card">
                    <h3>üíä Stack Compl√©ments</h3>
                    <div id="supplements-container" style="margin-top: 15px;">
                        <!-- JS Injected -->
                    </div>
                </div>

                <div class="card">
                    <h3>üíæ Sauvegarde & Donn√©es</h3>
                    <p style="font-size: 12px; color: var(--text-light); margin-bottom: 15px;">Sauvegardez vos donn√©es
                        pour ne pas les perdre.</p>
                    <button onclick="telechargerBackup()"
                        style="width: 100%; background: var(--success); color: white; padding: 12px; border-radius: 12px; font-weight: 700; margin-bottom: 10px;">‚¨áÔ∏è
                        T√©l√©charger Backup</button>
                    <button onclick="document.getElementById('input-restore').click()"
                        style="width: 100%; background: var(--text-light); color: white; padding: 12px; border-radius: 12px; font-weight: 700;">‚¨ÜÔ∏è
                        Restaurer Backup</button>
                    <input type="file" id="input-restore" accept=".json" style="display: none;"
                        onchange="restaurerBackup(event)">
                </div>
            </div>
        </main>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="switchTab('dashboard')">
            <div class="nav-icon">üìä</div>
            <span>Suivi</span>
        </div>
        <div class="nav-item active" onclick="switchTab('training')">
            <div class="nav-icon">üçΩÔ∏è</div>
            <span>Journal</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile')">
            <div class="nav-icon">üë§</div>
            <span>Profil</span>
        </div>
    </nav>

    <script>
        // --- CONSTANTS & DATA ---
        const SAISONS = {
            hiver: { nom: 'Hiver', mois: [12, 1, 2], emoji: '‚ùÑÔ∏è', fruits: ['Orange', 'Kiwi'], legumes: ['Poireau', 'Endive'] },
            printemps: { nom: 'Printemps', mois: [3, 4, 5], emoji: 'üå∏', fruits: ['Fraise', 'Cerise'], legumes: ['Asperge', 'Radis'] },
            ete: { nom: '√ât√©', mois: [6, 7, 8], emoji: '‚òÄÔ∏è', fruits: ['Melon', 'P√™che'], legumes: ['Tomate', 'Poivron'] },
            automne: { nom: 'Automne', mois: [9, 10, 11], emoji: 'üçÇ', fruits: ['Raisin', 'Figue'], legumes: ['Courge', 'Champignon'] }
        };

        const JOURS_SEMAINE = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        const PLAN_HYBRIDE = {
            dateDebut: localStorage.getItem('dateDebutProgramme') || new Date().toISOString().split('T')[0],
            poidsInitial: 93.4,
            semaines: {
                S1: { phase: 'seche', nom: 'S√®che S1', objectif: 'Kickstart s√®che intensive', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S2: { phase: 'seche', nom: 'S√®che S2', objectif: 'Acc√©l√©ration perte gras', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S3: { phase: 'seche', nom: 'S√®che S3', objectif: 'Momentum optimal', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S4: { phase: 'seche', nom: 'S√®che S4', objectif: 'Finalisation phase 1', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S5: { phase: 'deload', nom: 'Deload', objectif: 'R√©cup√©ration m√©tabolique', calories: { training: 2750, repos: 2350 }, macros: { training: { P: 230, G: 280, L: 85 }, repos: { P: 220, G: 200, L: 95 } }, deficitCible: 400, perteVisee: 0.3 },
                S6: { phase: 'seche', nom: 'S√®che S6', objectif: 'Reprise intensit√©', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S7: { phase: 'seche', nom: 'S√®che S7', objectif: 'Continuation s√®che', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S8: { phase: 'seche', nom: 'S√®che S8', objectif: 'Phase finale approche', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S9: { phase: 'seche', nom: 'S√®che S9', objectif: 'Derni√®re ligne droite', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.7 },
                S10: { phase: 'finale', nom: 'Finale', objectif: 'Bilan final & transition', calories: { training: 2580, repos: 2100 }, macros: { training: { P: 240, G: 250, L: 75 }, repos: { P: 240, G: 160, L: 75 } }, deficitCible: 420, perteVisee: 0.5 }
            }
        };

        const MENUS_BASE = {
            matin: {
                nom: 'Hydratation & √âveil',
                icon: 'assets/icon_morning.svg',
                heure: '07:30',
                details: ['üíß 500ml Eau + Jus 1/2 citron', '‚òï Caf√© Noir', 'üíä Cr√©atine : 5g', 'üíä Vitamine D3 : 5000 UI']
            },
            training: {
                repas: [
                    {
                        id: 'repas1_training',
                        nom: 'REPAS 1 - Pr√©-Training',
                        heure: '12:00',
                        calories: 1060,
                        macros: { P: 78, G: 141, L: 22 },
                        note: '‚è∞ Finir 1h45 avant training',
                        options: [
                            { id: 'A', nom: 'Option A - Poulet-Riz', aliments: ['üçó Poulet grill√© : 200g cuit', 'üçö Riz basmati : 270g cuit', 'ü•¶ L√©gumes : 300g', 'ü´í Huile olive : 15ml', 'üçå Banane : 1', 'üçé Pomme : 1'] },
                            { id: 'B', nom: 'Option B - Dinde-Quinoa', aliments: ['ü¶É Escalope dinde : 200g cuit', 'üåæ Quinoa : 255g cuit', 'ü•¶ Haricots verts : 350g', 'ü´í Huile olive : 15ml', 'üçå Banane : 1', 'üçä Orange : 1'] }
                        ],
                        supplements: ['üíä ARTICULATIONS : Glucosamine, Chondro√Øtine, MSM', '‚úÖ Cr√©atine 5g (si pas pris matin)'],
                        antiInflammatoires: ['üåø Curcuma frais', 'ü´ö Gingembre frais']
                    },
                    {
                        id: 'repas2_training',
                        nom: 'REPAS 2 - Post-Training',
                        heure: '15:45',
                        calories: 860,
                        macros: { P: 62, G: 148, L: 5 },
                        note: '‚è∞ 30 min post-training MAX',
                        aliments: ['üí™ SHAKER :', 'Whey isolate : 60g', 'Bananes : 3', 'Flocons avoine : 40g', 'Jus cerise : 150ml', 'Myrtilles : 100g', 'Miel : 10g']
                    },
                    {
                        id: 'repas3_training',
                        nom: 'REPAS 3 - Final',
                        heure: '19:30',
                        calories: 715,
                        macros: { P: 46, G: 54, L: 34 },
                        options: [
                            { id: 'A', nom: 'Option A - Saumon-Riz', aliments: ['üêü Saumon : 150g cuit', 'üçö Riz : 150g cuit', 'ü•ó Salade : 300g', 'ü´í Huile olive : 15ml', 'üå∞ Graines lin : 15g'] },
                            { id: 'B', nom: 'Option B - Poulet-Patate', aliments: ['üçó Poulet : 160g cuit', 'üç† Patate douce : 180g cuite', 'ü•ó Salade : 300g', 'ü´í Huile olive : 20ml'] }
                        ],
                        supplements: ['üíä SOIR : Om√©ga-3, Magn√©sium, Zinc, Glycine']
                    }
                ]
            },
            repos: {
                repas: [
                    {
                        id: 'repas1_repos',
                        nom: 'REPAS 1',
                        heure: '12:00',
                        calories: 935,
                        macros: { P: 76, G: 100, L: 27 },
                        options: [
                            { id: 'A', nom: 'Option A - Poulet-Riz', aliments: ['üçó Poulet : 200g cuit', 'üçö Riz : 210g cuit', 'ü•¶ L√©gumes : 400g', 'ü´í Huile olive : 20ml', 'üçé Pomme : 1'] },
                            { id: 'B', nom: 'Option B - Dinde-Quinoa', aliments: ['ü¶É Dinde : 200g cuit', 'üåæ Quinoa : 195g cuit', 'ü•¶ L√©gumes : 400g', 'ü´í Huile olive : 20ml', 'üçä Orange : 1'] }
                        ],
                        supplements: ['üíä ARTICULATIONS : Glucosamine, MSM, Boswellia']
                    },
                    {
                        id: 'repas2_repos',
                        nom: 'COLLATION',
                        heure: '16:00',
                        calories: 405,
                        macros: { P: 30, G: 49, L: 11 },
                        options: [
                            { id: 'A', nom: 'Option A - Skyr', aliments: ['üç∂ Skyr 0% : 250g', 'üçå Banane : 1', 'ü•ú Amandes : 20g', 'üçØ Miel : 10g'] },
                            { id: 'B', nom: 'Option B - ≈íufs', aliments: ['ü•ö ≈íufs durs : 3', 'üçå Banane : 1', 'üå∞ Noix : 20g', 'üçé Pomme : 1'] }
                        ]
                    },
                    {
                        id: 'repas3_repos',
                        nom: 'REPAS 3 - Soir',
                        heure: '19:30',
                        calories: 765,
                        macros: { P: 47, G: 55, L: 39 },
                        options: [
                            { id: 'A', nom: 'Option A - Saumon', aliments: ['üêü Saumon : 150g cuit', 'üç† Patate douce : 200g', 'ü•ó Salade : 350g', 'ü´í Huile olive : 20ml'] },
                            { id: 'B', nom: 'Option B - Poulet', aliments: ['üçó Poulet : 160g cuit', 'ü•î Pommes terre : 200g', 'ü•¶ L√©gumes : 400g', 'ü´í Huile olive : 25ml'] }
                        ],
                        supplements: ['üíä SOIR : Om√©ga-3, Magn√©sium, Zinc']
                    }
                ]
            },
            vendredi: {
                repas3: {
                    id: 'repas3_vendredi',
                    nom: 'Plaisir Contr√¥l√© (80/20)',
                    heure: '20:00',
                    calories: 875,
                    macros: { P: 73, G: 76, L: 30 },
                    aliments: ['ü•ó Salade verte (200g) en premier', 'ü•© Viande (200g)', 'üçü Frites Air Fryer (350g crues)', '‚ö†Ô∏è +160kcal vs repas normal']
                }
            }
        };

        const STACK_SUPPLEMENTS_COMPLET = {
            basique: {
                articulations: { glucosamine: { dose: '1500mg', prix: '15‚Ç¨/mois' }, msm: { dose: '2000mg', prix: '10‚Ç¨/mois' }, boswellia: { dose: '1000mg', prix: '15‚Ç¨/mois' } },
                performance: { creatine: { dose: '5g/j', prix: '8‚Ç¨/mois' }, whey: { dose: '60-90g/j', prix: '40‚Ç¨/mois' }, omega3: { dose: '2-4g/j', prix: '20‚Ç¨/mois' } },
                sante: { vitamine_d3: { dose: '5000 UI', prix: '8‚Ç¨/mois' }, magnesium: { dose: '400mg', prix: '10‚Ç¨/mois' }, zinc: { dose: '30mg', prix: '8‚Ç¨/mois' } }
            },
            diabete: {
                berberine: { dose: '500mg 3√ó/jour', prix: '15‚Ç¨/mois', note: 'PRIORIT√â #1' },
                chrome: { dose: '200mcg 2√ó/jour', prix: '5‚Ç¨/mois' }
            }
        };

        // --- STATE ---
        function getSaison() {
            const mois = new Date().getMonth() + 1;
            for (const [key, saison] of Object.entries(SAISONS)) {
                if (saison.mois.includes(mois)) return saison;
            }
            return SAISONS.automne;
        }

        let SAISON_ACTUELLE = getSaison();
        let semaineActuelle = 'S1';
        let jourType = 'training';
        let grignotages = JSON.parse(localStorage.getItem('grignotages') || '[]');
        let pesees = JSON.parse(localStorage.getItem('pesees-hebdo') || '[]');
        let optionsSelectionnees = JSON.parse(localStorage.getItem('options-repas') || '{}');
        let planningHebdo = JSON.parse(localStorage.getItem('planningHebdo') || '[1, 2, 4, 5]');
        let preferencesMenu = JSON.parse(localStorage.getItem('preferences-menu') || '{}');

        // --- INIT ---
        window.onload = function () {
            updateDateDisplay();
            updateSeasonDisplay();

            const dateInput = document.getElementById('date-debut-input');
            if (dateInput) dateInput.value = PLAN_HYBRIDE.dateDebut;

            semaineActuelle = getSemaineActuelle();
            createTimelineItems();
            afficherSemainier();
            renderConfigJours();
            checkDayAuto();
            loadGrignotages(); // NEW
            afficherMenu();
            calculerProgression();
            calculerProgressionProgramme();
            calculerSuiviPoids();
            afficherGraphiquePoids(); // NEW
            afficherHistoriquePesees(); // NEW
            afficherStackSupplements();
        };

        // --- FUNCTIONS ---
        function updateDateDisplay() {
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('fr-FR', options);
        }

        function updateSeasonDisplay() {
            SAISON_ACTUELLE = getSaison();
            document.getElementById('season-badge').textContent = SAISON_ACTUELLE.emoji + ' ' + SAISON_ACTUELLE.nom.toUpperCase();
        }

        function getSemaineActuelle() {
            const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
            const aujourdhui = new Date();
            const diffJours = Math.floor((aujourdhui - dateDebut) / (1000 * 60 * 60 * 24));
            const numSemaine = Math.floor(diffJours / 7) + 1;
            return 'S' + (numSemaine > 10 ? 10 : numSemaine < 1 ? 1 : numSemaine);
        }

        function updateDateDebut() {
            const input = document.getElementById('date-debut-input');
            if (input && input.value) {
                PLAN_HYBRIDE.dateDebut = input.value;
                localStorage.setItem('dateDebutProgramme', input.value);
                semaineActuelle = getSemaineActuelle();
                afficherMenu();
                calculerProgression();
                calculerProgressionProgramme();
                createTimelineItems();
            }
        }

        function createTimelineItems() {
            let html = '';
            for (let i = 1; i <= 10; i++) {
                const isActive = ('S' + i) === semaineActuelle;
                html += `<div class="timeline-item" onclick="afficherSemaine(${i})" 
                     style="flex: 0 0 auto; text-align: center; cursor: pointer; opacity: ${isActive ? '1' : '0.5'}; transform: ${isActive ? 'scale(1.1)' : 'scale(1)'}; transition: 0.3s;">
                     <div class="timeline-dot" style="width: 40px; height: 40px; background: ${isActive ? 'var(--primary)' : 'var(--primary-light)'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold;">
                     ${i}
                     </div>
                     <div class="timeline-label" style="font-size: 10px; margin-top: 4px; font-weight: 600;">Sem ${i}</div>
                     </div>`;
            }
            document.getElementById('timeline-items').innerHTML = html;
            setTimeout(scrollTimelineToActive, 100);
        }

        function scrollTimelineToActive() {
            const wrapper = document.querySelector('.timeline-wrapper');
            // Find the active item (opacity 1)
            const items = document.querySelectorAll('.timeline-item');
            let activeItem = null;
            items.forEach(item => {
                if (item.style.opacity === '1') activeItem = item;
            });

            if (activeItem && wrapper) {
                const offset = activeItem.offsetLeft - (wrapper.clientWidth / 2) + (activeItem.clientWidth / 2);
                wrapper.scrollTo({ left: offset, behavior: 'smooth' });
            }
        }

        function afficherSemaine(num) {
            semaineActuelle = 'S' + num;
            afficherMenu();
            calculerProgression();
            calculerProgressionProgramme();
            createTimelineItems();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const icons = { 'dashboard': 0, 'training': 1, 'profile': 2 };
            document.querySelectorAll('.nav-item')[icons[tabName]].classList.add('active');
        }

        function renderConfigJours() {
            const container = document.getElementById('config-jours-container');
            if (!container) return;
            let html = '';
            const ordre = [1, 2, 3, 4, 5, 6, 0];
            ordre.forEach(idx => {
                const isChecked = planningHebdo.includes(idx);
                html += `<label style="display: flex; align-items: center; gap: 8px; background: #f1f2f6; padding: 10px 15px; border-radius: 12px; cursor: pointer;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleConfigJour(${idx})">
                        <span style="font-size: 14px; font-weight: 600; color: var(--text-main);">${JOURS_SEMAINE[idx]}</span>
                     </label>`;
            });
            container.innerHTML = html;
        }

        function toggleConfigJour(dayIndex) {
            const idx = planningHebdo.indexOf(dayIndex);
            if (idx > -1) planningHebdo.splice(idx, 1);
            else planningHebdo.push(dayIndex);
            localStorage.setItem('planningHebdo', JSON.stringify(planningHebdo));
            afficherSemainier();
            renderConfigJours();
            if (dayIndex === new Date().getDay()) checkDayAuto();
        }

        function afficherSemainier() {
            const todayIndex = new Date().getDay();
            let html = '';
            const ordreJours = [1, 2, 3, 4, 5, 6, 0];
            ordreJours.forEach(idx => {
                const isTraining = planningHebdo.includes(idx);
                const isToday = idx === todayIndex;
                html += `<div class="jour-badge ${isTraining ? 'training' : 'repos'} ${isToday ? 'today' : ''}" onclick="toggleJourPlanning(${idx})">
                        <span>${JOURS_SEMAINE[idx]}</span>
                        <div class="jour-dot"></div>
                     </div>`;
            });
            document.getElementById('semainier-container').innerHTML = html;
        }

        function toggleJourPlanning(dayIndex) {
            toggleConfigJour(dayIndex);
        }

        function checkDayAuto() {
            const todayIndex = new Date().getDay();
            const isTrainingToday = planningHebdo.includes(todayIndex);
            const newType = isTrainingToday ? 'training' : 'repos';
            if (jourType !== newType) setDayType(newType);
            else loadDayType();
        }

        function setDayType(type) {
            jourType = type;
            localStorage.setItem('jourType', type);
            loadDayType();
            afficherMenu();
            calculerProgression();
        }

        function loadDayType() {
            const saved = localStorage.getItem('jourType');
            if (saved) jourType = saved;
            document.getElementById('day-display').textContent = jourType === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS';
            document.getElementById('day-display').style.color = jourType === 'training' ? 'var(--primary)' : 'var(--secondary)';
        }

        function afficherMenu() {
            const menu = MENUS_BASE[jourType];
            let html = '';

            // 1. ROUTINE MATIN
            const matin = MENUS_BASE.matin;
            html += `<div class="nutrition-section" style="background:#fff5f0; padding:15px; border-radius:20px; border:1px solid #ffeaa7; margin-bottom:20px;">
                <h3 style="color:#d35400; margin-bottom:10px; display:flex; align-items:center;">
                    <img src="${matin.icon}" class="menu-icon"> ${matin.nom}
                </h3>
                <ul style="list-style:none;">
                    ${matin.details.map(d => `<li style="margin-bottom:5px; font-size:13px;">${d}</li>`).join('')}
                </ul>
            </div>`;

            // 2. REPAS
            menu.repas.forEach(repas => {
                const dayIndex = new Date().getDay();
                let currentRepas = repas;
                let isVendrediSoir = (dayIndex === 5 && repas.id.includes('repas3'));

                if (isVendrediSoir) {
                    currentRepas = MENUS_BASE.vendredi.repas3;
                }

                const valide = isRepasValide(currentRepas.id);

                html += `<div class="nutrition-section">
                        <div style="display: flex; justify-content: space-between; align-items: baseline;">
                            <h3 style="display:flex; align-items:center;">
                                <img src="${currentRepas.icon || 'assets/icon_lunch.svg'}" class="menu-icon">
                                ${currentRepas.heure} - ${currentRepas.nom}
                            </h3>
                            ${isVendrediSoir ? '<span style="font-size: 10px; background: #ffeaa7; padding: 4px 8px; border-radius: 10px;">üéâ 80/20</span>' : ''}
                        </div>
                        
                        <div class="meal-details">
                            <div class="detail-item"><span class="stat-value" style="font-size: 16px;">${currentRepas.calories}</span><span class="detail-label">Kcal</span></div>
                            <div class="detail-item"><span class="stat-value" style="font-size: 16px;">${currentRepas.macros.P}</span><span class="detail-label">Prot</span></div>
                            <div class="detail-item"><span class="stat-value" style="font-size: 16px;">${currentRepas.macros.G}</span><span class="detail-label">Gluc</span></div>
                            <div class="detail-item"><span class="stat-value" style="font-size: 16px;">${currentRepas.macros.L}</span><span class="detail-label">Lip</span></div>
                        </div>

                        ${currentRepas.note ? `<p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px; font-style: italic;">${currentRepas.note}</p>` : ''}
                        ${currentRepas.supplements ? `<div style="margin-bottom: 15px; font-size: 13px; background: #eef2f3; padding: 10px; border-radius: 10px;"><strong>üíä Compl√©ments:</strong> ${currentRepas.supplements.join(', ')}</div>` : ''}
                        ${currentRepas.antiInflammatoires ? `<div style="margin-bottom: 15px; font-size: 13px; background: #eef2f3; padding: 10px; border-radius: 10px;"><strong>üåø Anti-inflammatoires:</strong> ${currentRepas.antiInflammatoires.join(', ')}</div>` : ''}
                        `;

                // OPTIONS / ASSIETTE
                if (currentRepas.options) {
                    const today = new Date().toISOString().split('T')[0];
                    const optionKey = `${today}-${currentRepas.id}`;
                    let defaultOption = currentRepas.options[0].id;
                    if (currentRepas.prefKey && preferencesMenu[currentRepas.prefKey]) {
                        defaultOption = preferencesMenu[currentRepas.prefKey];
                    }
                    const optionSelectionnee = optionsSelectionnees[optionKey] || defaultOption;
                    if (!optionsSelectionnees[optionKey]) optionsSelectionnees[optionKey] = defaultOption;

                    html += `<div style="margin-bottom: 15px;"><strong>üîÑ Choix option :</strong><br>`;
                    currentRepas.options.forEach(opt => {
                        const isActive = opt.id === optionSelectionnee;
                        html += `<button class="option-btn ${isActive ? 'active' : ''}" onclick="selectOption('${currentRepas.id}', '${opt.id}')">${opt.nom}</button>`;
                    });
                    html += `</div>`;

                    const optionChoisie = currentRepas.options.find(o => o.id === optionSelectionnee);
                    if (optionChoisie) {
                        html += `<ul style="padding-left: 20px; font-size: 14px;">${optionChoisie.aliments.map(a => `<li style="margin-bottom: 5px;">${a}</li>`).join('')}</ul>`;
                    }
                } else if (currentRepas.assiette) {
                    html += `<div style="margin-bottom: 10px;"><strong>üçΩÔ∏è L'Assiette :</strong></div>
                         <ul style="padding-left: 20px; font-size: 14px;">${currentRepas.assiette.map(a => `<li style="margin-bottom: 5px;">${a}</li>`).join('')}</ul>`;
                } else if (currentRepas.aliments) {
                    html += `<ul style="padding-left: 20px; font-size: 14px;">${currentRepas.aliments.map(a => `<li style="margin-bottom: 5px;">${a}</li>`).join('')}</ul>`;
                }

                if (currentRepas.dessert) {
                    html += `<div style="margin-top: 15px; font-size: 14px; color: var(--primary);"><strong>üç® Dessert :</strong> ${currentRepas.dessert}</div>`;
                }

                html += `<div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${currentRepas.id}')">
                        <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
                        <span><strong>${valide ? '‚úÖ Valid√©' : '‚è∏Ô∏è √Ä valider'}</strong></span>
                     </div>
                 </div>`;
            });

            document.getElementById('menu-container').innerHTML = html;
        }

        function selectOption(repasId, optionId) {
            const today = new Date().toISOString().split('T')[0];
            optionsSelectionnees[`${today}-${repasId}`] = optionId;
            localStorage.setItem('options-repas', JSON.stringify(optionsSelectionnees));
            afficherMenu();
            calculerProgression();
        }

        function toggleRepas(repasId) {
            const today = new Date().toISOString().split('T')[0];
            const key = `repas-${today}`;
            let validations = JSON.parse(localStorage.getItem(key) || '[]');
            const index = validations.indexOf(repasId);
            if (index > -1) validations.splice(index, 1);
            else validations.push(repasId);
            localStorage.setItem(key, JSON.stringify(validations));
            afficherMenu();
            calculerProgression();
        }

        function isRepasValide(repasId) {
            const today = new Date().toISOString().split('T')[0];
            return (JSON.parse(localStorage.getItem(`repas-${today}`) || '[]')).includes(repasId);
        }

        function calculerProgression() {
            const menu = MENUS_BASE[jourType];
            const config = PLAN_HYBRIDE.semaines[semaineActuelle] || PLAN_HYBRIDE.semaines['S1'];
            const today = new Date().toISOString().split('T')[0];
            const validations = JSON.parse(localStorage.getItem(`repas-${today}`) || '[]').filter(id => id !== 'repas3_vendredi'); // Filter out vendredi special meal for macro calculation

            let total = { cal: 0, p: 0, g: 0, l: 0 };

            validations.forEach(id => {
                let repas = menu.repas.find(r => r.id === id);
                if (repas) {
                    // If options exist, use the selected option's macros if available, otherwise default to first option or main macros
                    if (repas.options) {
                        const optionKey = `${today}-${repas.id}`;
                        const selectedOptionId = optionsSelectionnees[optionKey] || repas.options[0].id;
                        const selectedOption = repas.options.find(opt => opt.id === selectedOptionId);
                        // For now, we don't have macros per option, so we use the main meal macros
                        total.cal += repas.calories;
                        total.p += repas.macros.P;
                        total.g += repas.macros.G;
                        total.l += repas.macros.L;
                    } else {
                        total.cal += repas.calories;
                        total.p += repas.macros.P;
                        total.g += repas.macros.G;
                        total.l += repas.macros.L;
                    }
                }
            });

            // Handle vendredi special meal separately if validated
            if (isRepasValide('repas3_vendredi')) {
                const vendrediRepas = MENUS_BASE.vendredi.repas3;
                total.cal += vendrediRepas.calories;
                total.p += vendrediRepas.macros.P;
                total.g += vendrediRepas.macros.G;
                total.l += vendrediRepas.macros.L;
            }

            const grigJour = grignotages.filter(g => g.date === today);
            total.cal += grigJour.reduce((sum, g) => sum + g.calories, 0);

            const customGoal = localStorage.getItem('objectif-calories-' + jourType);
            const objectifCal = customGoal ? parseInt(customGoal) : config.calories[jourType];

            document.getElementById('cal-actuel').textContent = total.cal;
            document.getElementById('cal-total').textContent = objectifCal;
            document.getElementById('prot-actuel').textContent = total.p;
            document.getElementById('prot-total').textContent = config.macros[jourType].P;
            document.getElementById('gluc-actuel').textContent = total.g;
            document.getElementById('gluc-total').textContent = config.macros[jourType].G;
            document.getElementById('lip-actuel').textContent = total.l;
            document.getElementById('lip-total').textContent = config.macros[jourType].L;

            const pct = Math.min(100, Math.round((total.cal / objectifCal) * 100));
            document.getElementById('progress-bar').textContent = pct + '%';
            document.getElementById('progress-bar-visual').style.width = pct + '%';
        }

        function editObjectifCalories() {
            const currentGoal = document.getElementById('cal-total').textContent;
            const newGoal = prompt("Nouvel objectif calorique :", currentGoal);
            if (newGoal && !isNaN(newGoal)) {
                localStorage.setItem('objectif-calories-' + jourType, newGoal);
                calculerProgression();
            }
        }

        function calculerProgressionProgramme() {
            const num = parseInt(semaineActuelle.replace('S', ''));
            const pct = Math.min(100, Math.round((num / 10) * 100));
            const bar = document.getElementById('global-progress-bar');
            const label = document.getElementById('global-week-display');
            if (bar) bar.style.width = pct + '%';
            if (label) label.textContent = `${semaineActuelle}/10`;
        }

        function calculerSuiviPoids() {
            const dernierPoids = pesees.length > 0 ? pesees[pesees.length - 1].poids : PLAN_HYBRIDE.poidsInitial;
            const poidsDepart = PLAN_HYBRIDE.poidsInitial;

            const numSemaine = parseInt(semaineActuelle.replace('S', ''));
            const configSemaine = PLAN_HYBRIDE.semaines[semaineActuelle];

            let objectifPoidsFinal = poidsDepart;
            for (let i = 1; i <= 10; i++) {
                const s = PLAN_HYBRIDE.semaines['S' + i];
                objectifPoidsFinal -= s.perteVisee;
            }

            const objectifHebdo = (poidsDepart - objectifPoidsFinal) / 10; // Average weekly loss
            const objectifTheorique = poidsDepart - (objectifHebdo * (numSemaine - 1));

            const ecart = (dernierPoids - objectifTheorique).toFixed(1);

            document.getElementById('poids-actuel').textContent = dernierPoids + ' kg';
            document.getElementById('poids-objectif').textContent = objectifTheorique.toFixed(1) + ' kg';

            const ecartEl = document.getElementById('poids-ecart');
            if (ecartEl) {
                ecartEl.textContent = (ecart > 0 ? '+' : '') + ecart + ' kg';
                ecartEl.style.color = ecart <= 0 ? '#00b894' : '#ff7675';
            }
        }

        function afficherStackSupplements() {
            let html = '';
            for (const [cat, items] of Object.entries(STACK_SUPPLEMENTS_COMPLET.basique)) {
                html += `<div style="margin-bottom: 20px;"><h4 style="color: var(--secondary); margin-bottom: 10px; text-transform: uppercase; font-size: 12px;">${cat}</h4>
                     <ul style="list-style: none; background: #f8f9fa; padding: 15px; border-radius: 15px;">`;
                for (const [name, det] of Object.entries(items)) {
                    html += `<li style="font-size: 14px; margin-bottom: 8px; display: flex; justify-content: space-between;">
                            <span><strong>${name}</strong></span>
                            <span>${det.dose} <span style="color: #b2bec3; font-size: 12px;">(${det.prix})</span></span>
                         </li>`;
                }
                html += `</ul></div>`;
            }
            document.getElementById('supplements-container').innerHTML = html;
        }

        // --- NEW FUNCTIONS ---

        function ajouterGrignotage() {
            const nom = document.getElementById('input-snack-nom').value;
            const cal = parseInt(document.getElementById('input-snack-cal').value);
            if (nom && cal) {
                grignotages.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], nom, cal });
                localStorage.setItem('grignotages', JSON.stringify(grignotages));
                document.getElementById('input-snack-nom').value = '';
                document.getElementById('input-snack-cal').value = '';
                loadGrignotages();
                calculerProgression();
            }
        }

        function loadGrignotages() {
            const today = new Date().toISOString().split('T')[0];
            const list = document.getElementById('liste-grignotages');
            if (!list) return;
            const snacks = grignotages.filter(g => g.date === today);
            list.innerHTML = snacks.map(s => `
                <div class="snack-item">
                    <span>${s.nom}</span>
                    <strong>${s.cal} kcal</strong>
                </div>
            `).join('');
        }

        function enregistrerPesee() {
            const poids = parseFloat(document.getElementById('input-poids').value);
            const bf = parseFloat(document.getElementById('input-bf').value);
            const taille = parseFloat(document.getElementById('input-taille').value);
            const energie = document.getElementById('input-energie').value;
            const notes = document.getElementById('input-notes-pesee').value;

            if (!poids) return alert('Poids requis');

            const pesee = {
                date: new Date().toISOString().split('T')[0],
                semaine: semaineActuelle,
                poids, bf, taille, energie, notes
            };

            const existingIdx = pesees.findIndex(p => p.date === pesee.date);
            if (existingIdx > -1) pesees[existingIdx] = pesee;
            else pesees.push(pesee);

            pesees.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));

            alert('Pes√©e enregistr√©e !');
            calculerSuiviPoids();
            afficherGraphiquePoids();
            afficherHistoriquePesees();
        }

        function afficherGraphiquePoids() {
            const svg = document.getElementById('svg-poids');
            if (!svg || pesees.length < 2) {
                if (svg) svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#ccc">Ajoutez au moins 2 pes√©es</text>';
                return;
            }

            const width = svg.clientWidth;
            const height = svg.clientHeight;
            const padding = 20;

            const minP = Math.min(...pesees.map(p => p.poids)) - 1;
            const maxP = Math.max(...pesees.map(p => p.poids)) + 1;

            const points = pesees.map((p, i) => {
                const x = padding + (i / (pesees.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((p.poids - minP) / (maxP - minP)) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            svg.innerHTML = `
                <polyline points="${points}" fill="none" stroke="var(--primary)" stroke-width="3" />
                ${pesees.map((p, i) => {
                const x = padding + (i / (pesees.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((p.poids - minP) / (maxP - minP)) * (height - 2 * padding);
                return `<circle cx="${x}" cy="${y}" r="4" fill="white" stroke="var(--primary)" stroke-width="2" />`;
            }).join('')}
            `;
        }

        function afficherHistoriquePesees() {
            const container = document.getElementById('historique-pesees');
            if (!container) return;
            container.innerHTML = pesees.slice().reverse().map(p => `
                <div style="background: white; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 13px; display: flex; justify-content: space-between;">
                    <span>üìÖ ${new Date(p.date).toLocaleDateString('fr-FR')}</span>
                    <strong>${p.poids} kg</strong>
                </div>
            `).join('');
        }

        function telechargerBackup() {
            const data = {
                pesees, grignotages, optionsSelectionnees, planningHebdo, preferencesMenu,
                dateDebut: PLAN_HYBRIDE.dateDebut
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nutri-track-backup.json';
            a.click();
        }

        function restaurerBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const data = JSON.parse(e.target.result);
                localStorage.setItem('pesees-hebdo', JSON.stringify(data.pesees));
                localStorage.setItem('grignotages', JSON.stringify(data.grignotages));
                localStorage.setItem('options-repas', JSON.stringify(data.optionsSelectionnees));
                localStorage.setItem('planningHebdo', JSON.stringify(data.planningHebdo));
                localStorage.setItem('dateDebutProgramme', data.dateDebut);
                location.reload();
            };
            reader.readAsText(file);
        }
    </script>
</body>

</html>
